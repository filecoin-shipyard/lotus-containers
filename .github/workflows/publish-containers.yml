name: Build

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:

env:
  REGISTRY: ghcr.io
  IMAGE: ${{ github.repository }}
  # Edit these runner labels if your ARM runner differs:
  AMD64_RUNNER: ubuntu-latest
  ARM64_RUNNER: ubuntu-24.04-arm

jobs:
  setup-plan:
    name: Plan matrices
    runs-on: ubuntu-latest
    outputs:
      build_matrix:  ${{ steps.plan.outputs.build_matrix }}
      manifest_matrix: ${{ steps.plan.outputs.manifest_matrix }}
    steps:
      - name: Login GHCR (read)
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: plan
        shell: bash
        run: |
          set -euo pipefail

          # ---- Define versions/nets once ----
          versions=( \
            v1.23.1 v1.23.2 v1.23.3 v1.23.4-rc1 v1.23.4-rc2 \
            v1.24.0-rc1 v1.25.0-rc1 v1.24.0 v1.25.0 v1.25.1 v1.25.2 \
            v1.26.0-rc1 v1.26.0 v1.26.1 v1.26.2 v1.26.3 \
            v1.27.0 v1.27.1 v1.27.2 \
            v1.28.0 v1.28.1 v1.28.2 \
            v1.29.0 v1.29.1 v1.29.2 \
            v1.30.0 v1.31.0 \
            v1.32.0-rc1 v1.32.0-rc3 v1.32.1 v1.32.2 \
            v1.33.0 v1.33.1 \
          )

          # nets: name|goflags
          nets=(
            "mainnet|"
            "devnet|-tags=debug"
          )

          build_items=()     # JSON objects for arch builds
          manifest_items=()  # JSON objects for manifest creation

          repo="${{ env.REGISTRY }}/${{ env.IMAGE }}"

          # Helper: check manifest existence
          exists() { docker manifest inspect "$1" >/dev/null 2>&1; }

          for v in "${versions[@]}"; do
            for n in "${nets[@]}"; do
              IFS='|' read -r net_name goflags <<<"$n"
              base="${repo}:lotus-${v}-${net_name}"

              if exists "$base"; then
                # Multi-arch already present: nothing to do for this (v,net)
                continue
              fi

              # Final manifest missing -> ensure we create it later
              manifest_items+=( "{\"version\":\"$v\",\"net\":\"$net_name\"}" )

              # Check per-arch tags and only schedule missing ones
              amd_tag="${base}-amd64"
              arm_tag="${base}-arm64"

              if ! exists "$amd_tag"; then
                build_items+=( "{\"version\":\"$v\",\"net_name\":\"$net_name\",\"goflags\":\"$goflags\",\"arch\":\"amd64\",\"platform\":\"linux/amd64\",\"runs_on\":\"${{ env.AMD64_RUNNER }}\"}" )
              fi
              if ! exists "$arm_tag"; then
                build_items+=( "{\"version\":\"$v\",\"net_name\":\"$net_name\",\"goflags\":\"$goflags\",\"arch\":\"arm64\",\"platform\":\"linux/arm64\",\"runs_on\":\"${{ env.ARM64_RUNNER }}\"}" )
              fi
            done
          done

          # Emit JSON arrays (or empty arrays)
          build_json="[${build_items[*]-}]"
          manifest_json="[${manifest_items[*]-}]"

          # Normalize empty -> []
          [[ "$build_json" == "[]" || -z "${build_items[*]-}" ]] || true
          [[ "$manifest_json" == "[]" || -z "${manifest_items[*]-}" ]] || true

          echo "build_matrix=$build_json"       >> "$GITHUB_OUTPUT"
          echo "manifest_matrix=$manifest_json" >> "$GITHUB_OUTPUT"

  build:
    name: Build ${{ matrix.item.version }} • ${{ matrix.item.net_name }} • ${{ matrix.item.arch }}
    needs: setup-plan
    if: ${{ fromJSON(needs.setup-plan.outputs.build_matrix).length > 0 }}
    runs-on: ${{ matrix.item.runs_on }}   # native runner per arch; no QEMU
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        item: ${{ fromJSON(needs.setup-plan.outputs.build_matrix) }}
    steps:
      - uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/checkout@v3
        with:
          repository: filecoin-project/lotus
          ref: ${{ matrix.item.version }}
          path: lotus

      - uses: docker/setup-buildx-action@v2

      - name: Build & push (native)
        uses: docker/build-push-action@v4
        with:
          context: lotus
          platforms: ${{ matrix.item.platform }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE }}:lotus-${{ matrix.item.version }}-${{ matrix.item.net_name }}-${{ matrix.item.arch }}
          build-args: |
            GOFLAGS=${{ matrix.item.goflags }}

  manifest:
    name: Manifest ${{ matrix.item.version }} • ${{ matrix.item.net }}
    needs: [ setup-plan, build ]
    if: ${{ github.event_name != 'pull_request' && fromJSON(needs.setup-plan.outputs.manifest_matrix).length > 0 }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        item: ${{ fromJSON(needs.setup-plan.outputs.manifest_matrix) }}
    steps:
      - uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v2

      - name: Skip if final manifest appeared
        id: check
        shell: bash
        run: |
          BASE="${{ env.REGISTRY }}/${{ env.IMAGE }}:lotus-${{ matrix.item.version }}-${{ matrix.item.net }}"
          if docker manifest inspect "$BASE" >/dev/null 2>&1; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create/Update multi-arch manifest
        if: steps.check.outputs.skip != 'true'
        shell: bash
        run: |
          BASE="${{ env.REGISTRY }}/${{ env.IMAGE }}:lotus-${{ matrix.item.version }}-${{ matrix.item.net }}"
          AMD="${BASE}-amd64"
          ARM="${BASE}-arm64"

          ARGS=""
          docker manifest inspect "$AMD" >/dev/null 2>&1 && ARGS="$ARGS $AMD"
          docker manifest inspect "$ARM" >/dev/null 2>&1 && ARGS="$ARGS $ARM"

          if [ -z "$ARGS" ]; then
            echo "No arch images to stitch for $BASE"
            exit 0
          fi

          docker buildx imagetools create -t "$BASE" $ARGS
          docker buildx imagetools inspect "$BASE"
